<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - 美化PCB</title>
    <style>
        :root {
            --primary: #4285f4;
            --primary-hover: #3367d6;
            --danger: #dc3545;
            --text: #333;
            --text-secondary: #666;
            --text-hint: #999;
            --border: #e0e0e0;
            --bg: #f5f7fa;
            --card-bg: #fff;
            --input-bg: #f9f9f9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            color: var(--text);
            background-color: var(--bg);
            margin: 0;
            padding: 16px;
            overflow-x: hidden;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .card-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 20px;
            padding-left: 8px;
            border-left: 3px solid var(--primary);
            line-height: 1;
            color: #202124;
        }

        .setting-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-info {
            flex: 1;
            padding-right: 24px;
        }

        .setting-label {
            display: block;
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 4px;
            color: var(--text);
        }

        .setting-desc {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .setting-control {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
        }

        /* Input Groups */
        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input-bg);
            overflow: hidden;
            width: 140px;
            transition: border-color 0.2s;
        }
        
        .input-group:focus-within {
            border-color: var(--primary);
            background: #fff;
        }

        .input-group input {
            border: none;
            padding: 8px 10px;
            width: 100%;
            outline: none;
            background: transparent;
            font-size: 13px;
            color: var(--text);
            text-align: right;
        }

        .input-group .addon, .input-group select {
            background: #eee;
            border: none;
            border-left: 1px solid var(--border);
            padding: 0 10px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            outline: none;
            font-weight: 500;
        }
        
        .input-group select {
            cursor: pointer;
            padding-right: 4px;
        }

        /* Toggle Switch */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .switch-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
            outline: none;
        }

        .btn-white {
            background: #fff;
            border-color: var(--border);
            color: var(--text);
        }

        .btn-white:hover {
            background: #f8f8f8;
            border-color: #ccc;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: #fff;
            color: var(--danger);
            border-color: #ffdce0;
        }

        .btn-danger:hover {
            background: #fff5f5;
            border-color: var(--danger);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        
        .btn-ghost:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text);
        }

        /* Snapshot specific */
        .snapshot-container {
            border: 1px solid var(--border);
            border-radius: 6px;
            min-height: 100px;
            max-height: 180px;
            overflow-y: auto;
            background: #fafafa;
            margin-top: 12px;
        }

        .snapshot-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: var(--text-hint);
            font-size: 12px;
        }

        .snapshot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            background: #fff;
            transition: background 0.2s;
        }
        
        .snapshot-item:hover {
            background: #f0f7ff;
        }
        
        .snapshot-item:last-child {
            border-bottom: none;
        }

        .snapshot-meta {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 2px;
            color: var(--text);
        }
        
        .snapshot-details {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .footer-status {
            margin-top: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #28a745;
            font-weight: 500;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, 10px);
        }
        
        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    </style>
</head>
<body>

    <!-- General Settings -->
    <div class="card">
        <div class="card-title" data-i18n="通用设置">通用设置</div>

        <!-- Radius -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label" data-i18n="最大圆角半径">最大圆角半径</div>
                <div class="setting-desc" data-i18n="控制圆弧过渡的最大半径大小">控制圆弧过渡的最大半径大小</div>
            </div>
            <div class="setting-control">
                <div class="input-group">
                    <input type="number" id="cornerRadius" min="0.1" step="0.1" value="500">
                    <select id="unitSelect">
                        <option value="mil">mil</option>
                        <option value="mm">mm</option>
                    </select>
                </div>
            </div>
        </div>



        <!-- Sync Width -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label" data-i18n="自动线宽过渡">自动线宽过渡</div>
                <div class="setting-desc" data-i18n="圆滑时处理不同线宽">圆滑布线时是否自动处理不同线宽的过渡</div>
            </div>
            <div class="setting-control">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="syncWidthTransition">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label" id="syncWidthLabel" data-i18n="启用">启用</span>
                </div>
            </div>
        </div>

        <!-- Segments -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label" data-i18n="最大过渡段数">最大过渡段数</div>
                <div class="setting-desc" data-i18n="防止段数过多导致卡顿">线宽过渡的最大分段数，防止段数过多导致卡顿</div>
            </div>
            <div class="setting-control">
                <div class="input-group">
                    <input type="number" id="widthTransitionSegments" min="5" max="100" value="25">
                    <span class="addon" data-i18n="段">段</span>
                </div>
            </div>
        </div>

        <!-- Ratio -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label" data-i18n="过渡长度最大比例">过渡长度最大比例</div>
                <div class="setting-desc" data-i18n="过渡区长度比率">过渡区长度与线宽差值的最大比率，实际长度不超过窄端线长</div>
            </div>
            <div class="setting-control">
                <div class="input-group">
                    <input type="number" id="widthTransitionRatio" min="0.5" max="10" step="0.1" value="2.5">
                    <span class="addon">X</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced -->
    <div class="card">
        <div class="card-title" data-i18n="高级设置">高级设置</div>

        <!-- Merge Short Segments -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label">
                    <span data-i18n="合并短线段">合并短线段</span>
                    <span style="background:#fff3e0;color:#ef6c00;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px;">Beta</span>
                </div>
                <div class="setting-desc" data-i18n="自动合并过短的中间线段以生成圆弧">自动合并过短的中间线段以生成圆弧</div>
            </div>
            <div class="setting-control">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="mergeShortSegments" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label" id="mergeShortSegmentsLabel" data-i18n="启用">启用</span>
                </div>
            </div>
        </div>

        <!-- Force Arc -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label">
                    <span data-i18n="强制生成圆弧">强制生成圆弧</span>
                    <span style="background:#fff3e0;color:#ef6c00;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px;">Beta</span>
                </div>
                <div class="setting-desc" data-i18n="短线段导致圆弧不相切也生成（半径减小）">短线段导致圆弧不相切也生成（半径减小）</div>
            </div>
            <div class="setting-control">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="forceArc" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label" id="forceArcLabel" data-i18n="启用">启用</span>
                </div>
            </div>
        </div>

        <!-- Debug -->
        <div class="setting-item">
            <div class="setting-info">
                <div class="setting-label" data-i18n="调试模式">调试模式</div>
                <div class="setting-desc" data-i18n="启用调试日志">在日志栏打印</div>
            </div>
            <div class="setting-control">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="debug">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label" id="debugLabel" data-i18n="启用">启用</span>
                </div>
            </div>
        </div>

        <!-- Snapshot -->
        <div style="margin-top: 24px;">
            <div class="setting-item" style="border-top: 1px solid var(--border); padding-top: 20px; margin-bottom: 12px;">
                <div class="setting-info">
                    <div class="setting-label">
                        <span data-i18n="布线状态管理">布线状态管理</span>
                        <span id="snapshotCount" style="font-weight: normal; color: var(--text-hint); font-size: 12px; margin-left: 4px;"></span>
                    </div>
                    <div class="setting-desc" data-i18n="记录当前的布线状态，随时恢复">记录当前的布线状态，随时恢复</div>
                </div>
                <div class="setting-control" style="gap: 10px;">
                    <button type="button" class="btn btn-primary" id="createSnapshotBtn" data-i18n="记录当前布线状态">记录当前布线状态</button>
                    <button type="button" class="btn btn-danger" id="clearSnapshotsBtn" data-i18n="清除快照">清除快照</button>
                </div>
            </div>

            <div id="snapshotList" class="snapshot-container">
                <div class="snapshot-placeholder" data-i18n="暂无快照">暂无快照</div>
            </div>
        </div>
    </div>

    <div class="footer-status">
        <div class="status-badge" id="saveStatus">
            <span style="font-size: 14px;"></span> 
            <span data-i18n="设置即时生效">设置即时生效</span>
        </div>
        <button type="button" class="btn btn-white" id="closeBtn" onclick="tryClose()" data-i18n="关闭" style="min-width: 120px;">关闭</button>
    </div>
    
    <div id="toast" class="toast">Settings Saved</div>

    <script>
        /* global eda */
        
        // Helper to find the API object
        function getEda() {
            if (typeof eda !== 'undefined') return eda;
            if (window.parent && typeof window.parent.eda !== 'undefined') return window.parent.eda;
            if (window.top && typeof window.top.eda !== 'undefined') return window.top.eda;
            return null;
        }
        
        const API = getEda();

        if (!API) {
            console.error('JLC EDA API not found!');
            // Show visible error
            const errDiv = document.createElement('div');
            errDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;padding:10px;background:#ffebee;color:#c62828;text-align:center;z-index:9999;border-bottom:1px solid #ef9a9a;';
            errDiv.textContent = 'Error: Cannot connect to JLC EDA API. Please try reloading the extension.';
            document.body.prepend(errDiv);
        }

        function tryClose() {
             const api = API || getEda();
             if (api && api.sys_IFrame && api.sys_IFrame.closeIFrame) {
                 api.sys_IFrame.closeIFrame('settings');
             } else {
                 console.log('Close requested (API missing)');
             }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 1500);
        }

        function translatePage() {
            const api = API || getEda();
            if (!api || typeof api.sys_I18n === 'undefined') return;
            
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key) {
                    const text = api.sys_I18n.text(key);
                    if (text && text !== key) {
                        if (el.tagName === 'INPUT' && el.type === 'placeholder') {
                            el.placeholder = text;
                        } else {
                            // Don't overwrite if it has children like the switch slider, unless it's just text
                            if (el.children.length === 0) {
                                el.textContent = text;
                            }
                        }
                    }
                }
            });
            document.title = api.sys_I18n.text('设置');
        }

        // Elements
        const elCornerRadius = document.getElementById('cornerRadius');
        const elUnitSelect = document.getElementById('unitSelect');
        const elSyncWidth = document.getElementById('syncWidthTransition');
        const elSegments = document.getElementById('widthTransitionSegments');
        const elRatio = document.getElementById('widthTransitionRatio');
        const elDebug = document.getElementById('debug');
        const elForceArc = document.getElementById('forceArc');
        
        const elMergeShortSegments = document.getElementById('mergeShortSegments');
        
        // I18n labels update
        const elSyncWidthLabel = document.getElementById('syncWidthLabel');
        const elDebugLabel = document.getElementById('debugLabel');
        const elMergeShortSegmentsLabel = document.getElementById('mergeShortSegmentsLabel');
        const elForceArcLabel = document.getElementById('forceArcLabel');

        // 默认配置 (将在 init 中从 API 获取)
        let DEFAULT_CONFIG = {};

        let currentUnitState = 'mil';

        function updateSwitchLabels() {
            const api = API || getEda();
            const enabledText = (api && api.sys_I18n) ? api.sys_I18n.text('启用') : '启用';
            const disabledText = (api && api.sys_I18n) ? api.sys_I18n.text('禁用') : '禁用';
            
            elSyncWidthLabel.textContent = elSyncWidth.checked ? enabledText : disabledText;
            elDebugLabel.textContent = elDebug.checked ? enabledText : disabledText;
            elMergeShortSegmentsLabel.textContent = elMergeShortSegments.checked ? enabledText : disabledText;
            elForceArcLabel.textContent = elForceArc.checked ? enabledText : disabledText;
            
            // Visual feedback color for label
            elSyncWidthLabel.style.color = elSyncWidth.checked ? 'var(--primary)' : 'var(--text-secondary)';
            elDebugLabel.style.color = elDebug.checked ? 'var(--primary)' : 'var(--text-secondary)';
            elMergeShortSegmentsLabel.style.color = elMergeShortSegments.checked ? 'var(--primary)' : 'var(--text-secondary)';
            elForceArcLabel.style.color = elForceArc.checked ? 'var(--primary)' : 'var(--text-secondary)';
        }

        // Load
        async function loadSettings() {
            const api = API || getEda();
            if (!api) return;
            
            // 尝试同步默认配置配置
            if (typeof api.jlc_eda_beautify_getDefaultSettings === 'function') {
                try {
                    DEFAULT_CONFIG = api.jlc_eda_beautify_getDefaultSettings();
                    console.log('Loaded defaults from API', DEFAULT_CONFIG);
                } catch(e) {
                    console.error('Failed to load defaults', e);
                }
            }

            try {
                const settings = await api.sys_Storage.getExtensionAllUserConfigs();
                const config = {
                    ...DEFAULT_CONFIG,
                    ...settings,
                };

                elCornerRadius.value = config.cornerRadius;
                elUnitSelect.value = config.unit;
                currentUnitState = config.unit;
                elMergeShortSegments.checked = config.mergeShortSegments !== undefined ? config.mergeShortSegments : true;
                elSyncWidth.checked = config.syncWidthTransition;
                elSegments.value = config.widthTransitionSegments;
                elRatio.value = config.widthTransitionRatio;
                elDebug.checked = config.debug;
                elForceArc.checked = config.forceArc !== undefined ? config.forceArc : true;
                
                updateSwitchLabels();

            } catch (e) {
                console.error(e);
            }
        }

        // Save
        async function saveSettings(silent = false) {
            const api = API || getEda();
            if (!api) return;
            
            // Validate numbers
            let radius = parseFloat(elCornerRadius.value);
            if (isNaN(radius)) radius = DEFAULT_CONFIG.cornerRadius;
            
            let segments = parseInt(elSegments.value);
            if (isNaN(segments) || segments < 1) segments = DEFAULT_CONFIG.widthTransitionSegments;
            
            let ratio = parseFloat(elRatio.value);
            if (isNaN(ratio)) ratio = DEFAULT_CONFIG.widthTransitionRatio;

            const settings = {
                cornerRadius: radius,
                unit: elUnitSelect.value,
                mergeShortSegments: elMergeShortSegments.checked,
                syncWidthTransition: elSyncWidth.checked,
                widthTransitionSegments: segments,
                widthTransitionRatio: ratio,
                debug: elDebug.checked,
                forceArc: elForceArc.checked,
            };
            
            try {
                await api.sys_Storage.setExtensionAllUserConfigs(settings);
                updateSwitchLabels();
                
                // 通知插件主进程刷新设置缓存
                if (typeof api.jlc_eda_beautify_refreshSettings === 'function') {
                    await api.jlc_eda_beautify_refreshSettings();
                }
                
                if (!silent) {
                    const msg = api.sys_I18n ? api.sys_I18n.text('已保存') : 'Saved';
                    showToast(msg);
                }
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        // Bind Events
        [elCornerRadius, elSegments, elRatio].forEach(el => {
            el.addEventListener('change', () => saveSettings());
            // Debounce blur to prevent double save with change
            el.addEventListener('blur', (e) => {
               // Only save if value changed or just to be safe
               saveSettings(); 
            });
        });
        
        [elSyncWidth, elDebug, elMergeShortSegments, elForceArc].forEach(el => {
            el.addEventListener('change', () => saveSettings());
        });

        // Unit Conversion Logic
        elUnitSelect.addEventListener('change', (e) => {
            const newUnit = e.target.value;
            const val = parseFloat(elCornerRadius.value);
            let newVal = val;
            if (currentUnitState === 'mm' && newUnit === 'mil') newVal = val * 39.3701;
            else if (currentUnitState === 'mil' && newUnit === 'mm') newVal = val / 39.3701;
            
            elCornerRadius.value = newVal.toFixed(2);
            currentUnitState = newUnit;
            saveSettings();
        });

        // Snapshots
        const snapshotList = document.getElementById('snapshotList');
        
        async function refreshSnapshots() {
            const api = API || getEda();
            if (!api || !api.jlc_eda_beautify_snapshot) return;
            try {
                const snapshots = await api.jlc_eda_beautify_snapshot.getSnapshots();
                // 获取最后一次撤销的ID，用于显示标记
                let lastRestoredId = null;
                if (typeof api.jlc_eda_beautify_snapshot.getLastRestoredId === 'function') {
                    lastRestoredId = api.jlc_eda_beautify_snapshot.getLastRestoredId();
                    console.log('[Settings] Got lastRestoredId from API:', lastRestoredId, 'type:', typeof lastRestoredId);
                }
                
                console.log('[Settings] Snapshots:', snapshots.map(s => ({id: s.id, name: s.name})));
                
                // Update Count safely
                const countEl = document.getElementById('snapshotCount');
                if (countEl) countEl.textContent = '(' + snapshots.length + ')';
                
                snapshotList.innerHTML = '';
                if (snapshots.length === 0) {
                    const emptyText = api.sys_I18n ? api.sys_I18n.text('暂无快照') : '暂无快照';
                    snapshotList.innerHTML = '<div class="snapshot-placeholder">' + emptyText + '</div>';
                    return;
                }

                // 确保按时间倒序显示（最新的在最上面）
                const sorted = [...snapshots].sort((a, b) => b.timestamp - a.timestamp);
                
                sorted.forEach((snap, index) => {
                    const div = document.createElement('div');
                    div.className = 'snapshot-item';
                    
                    const timeStr = new Date(snap.timestamp).toLocaleTimeString();
                    let nameStr = snap.name;
                    if (!nameStr) {
                         nameStr = api.sys_I18n ? api.sys_I18n.text('自动快照') : 'Automatic Snapshot';
                    } else if (api.sys_I18n && (nameStr === '手动快照' || nameStr === 'Manual Snapshot')) {
                         nameStr = api.sys_I18n.text(nameStr);
                    }
                    
                    // 如果是最后一次撤销的快照，添加标记 (使用 == 进行宽松比较，避免类型问题)
                    let badgeHtml = '';
                    
                    const isLastRestored = lastRestoredId !== null && String(snap.id) === String(lastRestoredId);
                    if (isLastRestored) {
                         const undoText = api.sys_I18n ? api.sys_I18n.text('上次撤销至此') : 'Last Undo Point';
                         badgeHtml += `<span style="background:#e3f2fd;color:#1976d2;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px;">${undoText}</span>`;
                         console.log('[Settings] Badge shown for snapshot:', snap.id);
                    }

                    // 如果是最新的快照
                    if (index === 0) {
                        const latestText = api.sys_I18n ? api.sys_I18n.text('最新') : 'Latest';
                        badgeHtml += `<span style="background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px;">${latestText}</span>`;
                    }

                    const recoverText = api.sys_I18n ? api.sys_I18n.text('恢复') : 'Recover';
                    const deleteText = api.sys_I18n ? api.sys_I18n.text('删除') : 'Del';
                    const linesCount = snap.lines ? snap.lines.length : 0;
                    const arcsCount = snap.arcs ? snap.arcs.length : 0;
                    const linesText = `${linesCount} Lines, ${arcsCount} Arcs`;
                    
                        div.innerHTML = `
                        <div style="flex:1;overflow:hidden;">
                            <div class="snapshot-meta">${nameStr}${badgeHtml}</div>
                            <div class="snapshot-details">${timeStr} · ${linesText}</div>
                        </div>
                        <div style="display:flex;gap:4px;">
                            <button type="button" class="btn btn-white btn-recover" style="padding:4px 10px;font-size:12px;">${recoverText}</button>
                            <button type="button" class="btn btn-ghost btn-delete" style="padding:4px 8px;font-size:12px;color:#d32f2f;" title="${deleteText}">✕</button>
                        </div>
                    `;
                    
                    // Recover Button
                    div.querySelector('.btn-recover').onclick = () => {
                        const confirmText = api.sys_I18n ? api.sys_I18n.text('确定要恢复到此状态吗？') : 'Confirm restore?';
                        if (api.sys_Dialog) {
                            api.sys_Dialog.showConfirmationMessage(confirmText, api.sys_I18n ? api.sys_I18n.text('恢复快照') : 'Restore Snapshot', undefined, undefined, async (ok) => {
                                if (ok) {
                                    try {
                                        const result = await api.jlc_eda_beautify_snapshot.restoreSnapshot(snap.id);
                                        if (result) {
                                            const restoredText = api.sys_I18n ? api.sys_I18n.text('已恢复') : 'Restored';
                                            showToast(restoredText);
                                        } else {
                                            api.sys_Dialog.showInformationMessage('Restore returned false');
                                        }
                                    } catch(err) {
                                        api.sys_Dialog.showInformationMessage('Restore failed: ' + err);
                                    }
                                }
                            });
                        }
                    };

                    // Delete Button
                    div.querySelector('.btn-delete').onclick = (e) => {
                        e.stopPropagation(); // 阻止冒泡
                         const confirmDelText = api.sys_I18n ? api.sys_I18n.text('确定要删除此快照吗？') : 'Delete this snapshot?';
                         if (api.sys_Dialog) {
                             api.sys_Dialog.showConfirmationMessage(confirmDelText, api.sys_I18n ? api.sys_I18n.text('删除快照') : 'Delete Snapshot', undefined, undefined, async (ok) => {
                                 if (ok) {
                                     await api.jlc_eda_beautify_snapshot.deleteSnapshot(snap.id);
                                 }
                             });
                         }
                    };
                    
                    snapshotList.appendChild(div);
                });
            } catch (e) {
                console.error('Snapshot refresh error:', e);
                snapshotList.innerHTML = '<div style="padding:10px;color:red">Error loading snapshots</div>';
            }
        }

        document.getElementById('createSnapshotBtn').onclick = async () => {
            const api = API || getEda();
            if (!api || !api.jlc_eda_beautify_snapshot) {
                if (api && api.sys_Dialog) {
                    api.sys_Dialog.showInformationMessage('API not ready (jlc_eda_beautify_snapshot missing)');
                } else {
                    console.error('API not ready (jlc_eda_beautify_snapshot missing)');
                }
                return;
            }
            try {
                const name = api.sys_I18n ? api.sys_I18n.text('手动快照') : 'Manual Snapshot';
                await api.jlc_eda_beautify_snapshot.createSnapshot(name);
                await refreshSnapshots();
                showToast(api.sys_I18n ? api.sys_I18n.text('快照已创建') : 'Snapshot Created');
            } catch (e) {
                console.error('Create Snapshot Error:', e);
                if (api.sys_Dialog) {
                    api.sys_Dialog.showInformationMessage('Create Snapshot Error: ' + e);
                } else {
                    console.error('Create Snapshot Error: ' + e);
                }
            }
        };

        document.getElementById('clearSnapshotsBtn').onclick = () => {
            const api = API || getEda();
            if (!api || !api.jlc_eda_beautify_snapshot) return;
            const confirmText = api.sys_I18n ? api.sys_I18n.text('确定要清除所有快照吗？') : 'Clear all snapshots?';
            
            if (api.sys_Dialog) {
                api.sys_Dialog.showConfirmationMessage(confirmText, api.sys_I18n ? api.sys_I18n.text('清除快照') : 'Clear Snapshots', undefined, undefined, async (ok) => {
                    if (ok) {
                        await api.jlc_eda_beautify_snapshot.clearSnapshots();
                        await refreshSnapshots();
                        showToast(api.sys_I18n ? api.sys_I18n.text('已清除') : 'Cleared');
                    }
                });
            }
        };

        // Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            loadSettings().then(() => {
                translatePage();
                refreshSnapshots();
                
                // 注册快照变化回调，当主代码创建/删除快照时自动刷新列表
                const api = API || getEda();
                if (api && api.jlc_eda_beautify_snapshot && typeof api.jlc_eda_beautify_snapshot.registerSnapshotChangeCallback === 'function') {
                    // 使用新版显式注册接口
                    api.jlc_eda_beautify_snapshot.registerSnapshotChangeCallback(() => {
                        refreshSnapshots().catch(err => {
                            console.error('[Settings] Snapshot refresh failed:', err);
                        });
                    });
                    console.log('[Settings] Snapshot callback registered');
                } else if (api) {
                   // 兼容旧版
                    api._onSnapshotChange = () => {
                        refreshSnapshots();
                    };
                    console.log('[Settings] Using fallback _onSnapshotChange');
                }
                
                // 额外保险：定时轮询检查快照数量变化
                let lastSnapshotCount = -1;
                
                const poller = async () => {
                    const currentApi = API || getEda();
                    if (!currentApi || !currentApi.jlc_eda_beautify_snapshot) return;
                    
                    try {
                        const snapshots = await currentApi.jlc_eda_beautify_snapshot.getSnapshots();
                        
                        // 只有数量变化时才重绘列表
                        if (snapshots.length !== lastSnapshotCount && lastSnapshotCount !== -1) {
                            refreshSnapshots();
                        }
                        lastSnapshotCount = snapshots.length;
                    } catch (e) {
                         // ignore polling errors
                    }
                };

                // 启动轮询 (3秒一次，维持低频心跳)
                setInterval(poller, 3000);
            });
        }
    </script>
</body>
</html>